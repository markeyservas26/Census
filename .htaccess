# Enable the rewrite engine
RewriteEngine On

Options +FollowSymLinks

RewriteBase /

# Force www. version of the site (Optional)
RewriteCond %{HTTP_HOST} ^bantayanislandcensus.com [NC]
RewriteRule ^(.*)$ https://www.bantayanislandcensus.com/$1 [L,R=301]

# Redirect to HTTPS for all traffic
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://www.bantayanislandcensus.com%{REQUEST_URI} [L,R=301]

# Redirect all traffic to loading.php first (optional)
RewriteRule ^$ /loading.php [L]

# Redirect all traffic to the alert_access.php for monitoring access (adjusted to exclude necessary pages)
RewriteCond %{REQUEST_URI} !^/block_server.php$
RewriteRule ^(.*)$ /block_server.php [L]

# Friendly URL Rewriting (maps /page to /page.php)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ $1.php [L]

# Custom Error Pages
ErrorDocument 404 /404.php
ErrorDocument 403 /403.php

# PHP Settings (Optional)
php_value memory_limit 128M
php_value max_execution_time 60

# Disable Directory Browsing
Options -Indexes

# Block Access to Sensitive Files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|env)$">
  Order allow,deny
  Deny from all
</FilesMatch>

# Prevent Hotlinking of Images
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?bantayanislandcensus.com [NC]
RewriteRule \.(jpg|jpeg|png|gif)$ - [F]

# Cache-Control Headers (Optional, for performance)
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>

# Remove .php extension
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+)$ $1.php [L]

# Secure Headers for HTTPS (Strict Transport Security, X-Frame-Options, X-Content-Type-Options)
<VirtualHost *:443>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
</VirtualHost>

# Additional security headers
<IfModule mod_headers.c>
    Header set Referrer-Policy "no-referrer-when-downgrade"
    Header set Permissions-Policy "geolocation=(self), camera=(), microphone=()"
</IfModule>
